import streamlit as st 
import time 
from datetime import datetime 
import random 
import hashlib
st.markdown(
    """
    <a href="http://localhost:5000" target="_blank" style="text-decoration:none;">
        <div style="
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
        ">
            Home
        </div>
    </a>
    """,
    unsafe_allow_html=True
)
# ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹åˆ¶å¾¡ç”¨ã®å¤‰æ•°ã‚’è¿½åŠ 
nmap_progress = 0
exploit_progress = 0

def display_ascii_art(art_type):
    if art_type == "target":
        return """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Metasploitable2 â•‘
â•‘ 192.168.1.100 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    elif art_type == "attacker":
        return """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Attacker Machine â•‘
â•‘ 192.168.1.10 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    elif art_type == "transfer":
        return """
-----> * -----> * -----> ãƒ‡ãƒ¼ã‚¿è»¢é€ä¸­...
<----- * <----- * <-----
"""

def simulate_typing(text):
    placeholder = st.empty()
    displayed_text = ""
    for char in text:
        displayed_text += char
        placeholder.text(displayed_text)
        time.sleep(0.05)
    return placeholder

def manual_pentest():
    global nmap_progress, exploit_progress
    st.subheader("æ‰‹å‹•ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ")
    
    col1, col2 = st.columns(2)
    with col1:
        st.text(display_ascii_art("attacker"))
    with col2:
        st.text(display_ascii_art("target"))

    # Step 1: IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚¹ã‚­ãƒ£ãƒ³
    st.write("Step 1: å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã®èª¿æŸ»")
    st.code("å…¥åŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: nmap -sV 192.168.1.100")
    nmap_input = st.text_input("ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="nmap")
    
    if nmap_input:
        if nmap_input.lower() != "nmap -sv 192.168.1.100":
            st.error("æ­£ç¢ºã« 'nmap -sV 192.168.1.100' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„")
        elif 'nmap_executed' not in st.session_state:
            status_text = st.empty()
            if 'count' not in st.session_state:
                st.session_state["count"] = 0
                if(st.session_state["count"]==0):
                    for i in range(100):
                        status_text.text(f"[{i+1}/100] ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­...")
                        time.sleep(0.05)
                st.session_state["count"] += 1


            st.write("ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†...\n")
            st.code("""
PORT     STATE    SERVICE    VERSION
21/tcp   open    ftp        vsftpd 2.3.4
22/tcp   open    ssh        OpenSSH 4.7p1
23/tcp   open    telnet     Linux telnetd
25/tcp   open    smtp       Postfix smtpd
80/tcp   open    http       Apache httpd 2.2.8

æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ä¸€è¦§
ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ¼ãƒˆã®éœ²å‡º
FTP (21/tcp)
SSH (22/tcp)
Telnet (23/tcp)
SMTP (25/tcp)
HTTP (80/tcp)
å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹
vsftpd 2.3.4 (æ—¢çŸ¥ã®è„†å¼±æ€§ã‚ã‚Š)
OpenSSH 4.7p1 (å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³)
Apache httpd 2.2.8 (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¿…è¦)
""")
            st.session_state.step1_complete = True

    # Step 2: Metasploitã®èµ·å‹•
    if 'step1_complete' in st.session_state:
        st.write("Step 2: Metasploitã®èµ·å‹•")
        st.code("å…¥åŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: msfconsole")
        msf_input = st.text_input("ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="msf")
        if msf_input:
            if msf_input.lower() != "msfconsole":
                st.error("æ­£ç¢ºã« 'msfconsole' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„")
            else:
                st.code("msf6 >")
                st.session_state.step2_complete = True
    # Step 3: æ”»æ’ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é¸æŠ
    if 'step2_complete' in st.session_state:
        st.write("Step 3: æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã«å¯¾ã™ã‚‹æ”»æ’ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é¸æŠ")
        
        # åˆ©ç”¨å¯èƒ½ãªæ”»æ’ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©
        exploit_modules = {
            "FTP Backdoor (vsftpd 2.3.4)": "exploit/unix/ftp/vsftpd_234_backdoor",
            "SSH Exploit (OpenSSH 4.7p1)": "exploit/unix/ssh/openssh_compat",
            "Apache HTTPd Exploit": "exploit/unix/http/apache_22_backdoor",
            "Telnet Backdoor": "exploit/unix/telnet/telnetd_exploit"
        }
        
        # ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é¸æŠ
        selected_module_name = st.selectbox(
            "ä½¿ç”¨ã™ã‚‹æ”»æ’ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„:",
            list(exploit_modules.keys())
        )
        
        # é¸æŠã•ã‚ŒãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
        selected_module = exploit_modules[selected_module_name]
        
        if selected_module:
            st.code(f"ä½¿ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: use {selected_module}")
            
            # å®Ÿè¡Œãƒœã‚¿ãƒ³
            if st.button("ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ"):
                st.code(f"msf6 {selected_module} >")
                st.success(f"{selected_module_name}ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ")
                st.session_state.step3_complete = True


    # Step 4: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®è¨­å®š
    if 'step3_complete' in st.session_state:
        st.write("Step 4: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆIPã®è¨­å®š")
        st.code("å…¥åŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: set RHOSTS 192.168.1.100")
        rhost_input = st.text_input("ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="rhost")
        if rhost_input:
            if rhost_input.lower() != "set rhosts 192.168.1.100":
                st.error("æ­£ç¢ºã« 'set RHOSTS 192.168.1.100' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„")
            else:
                st.code("RHOSTS => 192.168.1.100")
                st.session_state.step4_complete = True

    # Step 5: æ”»æ’ƒå®Ÿè¡Œ
    if 'step4_complete' in st.session_state:
            st.write("Step 5: ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®å®Ÿè¡Œ")
            st.code("å…¥åŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: run")
            run_input = st.text_input("ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="run")
            
            if run_input:
                if run_input.lower() not in ["exploit", "run"]:
                    st.error("'run' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„")
                elif 'exploit_executed' not in st.session_state:
                    status_text = st.empty()
                    if 'count1' not in st.session_state:
                            st.session_state["count1"] = 0
                            if(st.session_state["count1"]==0):
                                for i in range(100):
                                    status_text.text(f"[{i+1}/100] ä¾µå…¥å‡¦ç†å®Ÿè¡Œä¸­...")
                                    time.sleep(0.08)
                            st.session_state["count1"] += 1
                    
                    st.success("ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹æˆåŠŸ!")
                    st.text(display_ascii_art("transfer"))
                    st.session_state.step5_complete = True
                    st.session_state.exploit_executed = True

    # Step 6: æƒ…å ±åé›†
    if 'step5_complete' in st.session_state:
        st.write("æœ€çµ‚Step: ã‚·ã‚¹ãƒ†ãƒ å†…ã®æƒ…å ±åé›†")
        st.code("å…¥åŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: cat /etc/passwd")
        cat_input = st.text_input("ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", key="cat")
        if cat_input:
            if cat_input.lower() != "cat /etc/passwd":
                st.error("æ­£ç¢ºã« 'cat /etc/passwd' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„")
            else:
                
                with st.spinner('ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...'):
                    time.sleep(2)
                departments = ['å–¶æ¥­éƒ¨', 'æŠ€è¡“éƒ¨', 'äººäº‹éƒ¨', 'çµŒç†éƒ¨', 'ä¼ç”»éƒ¨']
                positions = ['éƒ¨é•·', 'èª²é•·', 'ä¸»ä»»', 'ç¤¾å“¡']
                personal_data = []
                for i in range(50):
                    name = f"user{i:03d}"
                    email = f"{name}@metasploitable.local"
                    dept = random.choice(departments)
                    pos = random.choice(positions)
                    salary = random.randint(300000, 800000)
                    phone = f"0{random.randint(70,90)}-{random.randint(1000,9999)}-{random.randint(1000,9999)}"
                    personal_data.append({
                        "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID": name,
                        "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹": email,
                        "éƒ¨ç½²": dept,
                        "å½¹è·": pos,
                        "çµ¦ä¸": f"Â¥{salary:,}",
                        "é›»è©±ç•ªå·": phone,
                        "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥": hashlib.md5(name.encode()).hexdigest()
                    })
                st.write("### ğŸš¨ å–å¾—ã•ã‚ŒãŸæ©Ÿå¯†æƒ…å ± ğŸš¨")
                st.table(personal_data[:10])
                with st.expander("ã•ã‚‰ã«å¤šãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º"):
                    st.table(personal_data[10:])
                st.write("### ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æ")
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°", len(personal_data))
                with col2:
                    st.metric("å¹³å‡çµ¦ä¸", "Â¥523,450")
                with col3:
                    st.metric("è„†å¼±ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", "92%")



def auto_pentest():
    st.subheader("LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹è‡ªå‹•ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ")
    
    if st.button("è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹"):
        agent_thoughts = [
            "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã®åˆ†æã‚’é–‹å§‹ã—ã¾ã™...",
            "IPã‚¢ãƒ‰ãƒ¬ã‚¹ 192.168.1.100 ã«å¯¾ã—ã¦nmapã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™",
            "æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã‚’åˆ†æä¸­...",
            "vsftpd 2.3.4ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ",
            "æœ€é©ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ã„ã¾ã™...",
            "exploit/unix/ftp/vsftpd_234_backdoor ã‚’ä½¿ç”¨ã—ã¾ã™",
            "ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...",
            "ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ä¾µå…¥ã‚’è©¦ã¿ã¦ã„ã¾ã™..."
        ]

        for thought in agent_thoughts:
            st.write("ğŸ¤– Agentæ€è€ƒ: " + thought)
            st.text(display_ascii_art("transfer"))
            time.sleep(2)

        st.success("ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«æˆåŠŸã—ã¾ã—ãŸ")
        
        personal_info = {
            "ãƒ¦ãƒ¼ã‚¶ãƒ¼å": ["yamada_taro", "suzuki_hanako", "tanaka_ichiro"],
            "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹": ["yamada@example.com", "suzuki@example.com", "tanaka@example.com"],
            "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥": ["5f4dcc3b5aa765d61d8327deb882cf99", "e99a18c428cb38d5f260853678922e03", "6eea9b7ef19179a06954edd0f6c05ceb"]
        }
        
        st.write("å–å¾—ã•ã‚ŒãŸå€‹äººæƒ…å ±:")
        st.table(personal_info)

def main():
    st.title("Metasploitable2 ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆä½“é¨“")
    st.write("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç¿’ç”¨ç’°å¢ƒã§ã®ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆä½“é¨“")

    tab1, tab2 = st.tabs(["æ‰‹å‹•å®Ÿè¡Œ", "è‡ªå‹•å®Ÿè¡Œ"])
    
    with tab1:
        manual_pentest()
    with tab2:
        auto_pentest()

if __name__ == "__main__":
    main()
